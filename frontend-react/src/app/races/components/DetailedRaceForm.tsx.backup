'use client'

import React, { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '@/hooks/useAuth'
import { useToastHelpers } from '@/components/UI/Toast'
import { formatDateToSlash, formatDateFromSlash, getCurrentDateSlash } from '@/utils/dateFormat'
import { DateInput } from '@/components/UI/DateInput'

export function DetailedRaceForm() {
  const { isAuthenticated, isLoading: authLoading } = useAuth()
  const router = useRouter()
  const toast = useToastHelpers()
  const [formData, setFormData] = useState({
    raceName: '',
    date: getCurrentDateSlash(),
    raceType: 'track',
    distance: 0,
    raceSubType: '', // äºˆé¸ãƒ»æ±ºå‹ãƒ»è¨˜éŒ²ä¼šã®æƒ…å ±
    timeSeconds: 0,
    pace: '',
    position: '',
    participants: '',
    notes: ''
  });

  const [timeString, setTimeString] = useState('');
  const [timeError, setTimeError] = useState('');
  const [selectedDistance, setSelectedDistance] = useState('');
  const [selectedSubType, setSelectedSubType] = useState('');
  const [customDistance, setCustomDistance] = useState('');
  
  // ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ æ©Ÿèƒ½
  const [lapTimes, setLapTimes] = useState<Array<{lap: number, time: string, seconds: number, distance: number}>>([]);
  const [currentLap, setCurrentLap] = useState('');
  const [currentLapDistance, setCurrentLapDistance] = useState('');
  
  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  useEffect(() => {
    if (!authLoading && !isAuthenticated) {
      router.push('/login')
      return
    }
  }, [isAuthenticated, authLoading, router])

  // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
  const AUTO_SAVE_KEY = 'detailed_race_form_draft'
  
  // åˆæœŸåŒ–æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
  useEffect(() => {
    try {
      const savedData = localStorage.getItem(AUTO_SAVE_KEY)
      if (savedData) {
        const parsedData = JSON.parse(savedData)
        setFormData(parsedData.formData || formData)
        setTimeString(parsedData.timeString || '')
        setSelectedDistance(parsedData.selectedDistance || '')
        setSelectedSubType(parsedData.selectedSubType || '')
        setCustomDistance(parsedData.customDistance || '')
        setLapTimes(parsedData.lapTimes || [])
        console.log('ğŸ“ è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ')
      }
    } catch (error) {
      console.error('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:', error)
    }
  }, [])

  // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      try {
        const saveData = {
          formData,
          timeString,
          selectedDistance,
          selectedSubType,
          customDistance,
          lapTimes
        }
        localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(saveData))
        console.log('ğŸ’¾ è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ')
      } catch (error) {
        console.error('è‡ªå‹•ä¿å­˜ã«å¤±æ•—:', error)
      }
    }, 1000) // 1ç§’å¾Œã«ä¿å­˜

    return () => clearTimeout(timeoutId)
  }, [formData, timeString, selectedDistance, selectedSubType, customDistance, lapTimes])

  // è·é›¢ã«åŸºã¥ããƒ©ãƒƒãƒ—è·é›¢ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
  const getLapDistanceTemplate = () => {
    if (formData.raceType === 'track') {
      switch(formData.distance) {
        case 800: return 400; // 400m Ã— 2å‘¨
        case 1500: return 400; // 400m Ã— 3.75å‘¨
        case 3000: return 1000; // 1000m Ã— 3å‘¨
        case 5000: return 1000; // 1000m Ã— 5å‘¨
        case 10000: return 1000; // 1000m Ã— 10å‘¨
        default: return 400;
      }
    } else if (formData.raceType === 'road') {
      switch(formData.distance) {
        case 5000: return 1000; // 1kmåˆ»ã¿
        case 10000: return 1000; // 1kmåˆ»ã¿
        case 21097: return 5000; // 5kmåˆ»ã¿
        case 42195: return 5000; // 5kmåˆ»ã¿
        default: return 1000;
      }
    } else {
      return 1000; // é§…ä¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }
  };

  // ç§’æ•°ã‚’æ™‚é–“æ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆè¡¨ç¤ºç”¨ï¼‰
  const formatSecondsToTime = (totalSeconds: number) => {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toFixed(2).padStart(5, '0')}`;
    } else {
      return `${minutes}:${seconds.toFixed(2).padStart(5, '0')}`;
    }
  };

  // ç§’æ•°å…¥åŠ›ã‚’æ™‚é–“å½¢å¼ã«è‡ªå‹•å¤‰æ›
  const formatSecondsInput = (input: string) => {
    // æ•°å­—ã®ã¿ã®å ´åˆã¯ç§’æ•°ã¨ã—ã¦æ‰±ã†
    const numValue = parseFloat(input);
    if (!isNaN(numValue) && /^\d+\.?\d*$/.test(input)) {
      if (numValue >= 60) {
        const minutes = Math.floor(numValue / 60);
        const seconds = (numValue % 60).toFixed(2);
        return `${minutes}:${seconds.padStart(5, '0')}`;
      } else {
        // 60ç§’æœªæº€ã®å ´åˆã¯0:XX.XXå½¢å¼
        return `0:${numValue.toFixed(2).padStart(5, '0')}`;
      }
    }
    return input; // MM:SSå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾
  };

  // ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleLapTimeChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setCurrentLap(value);
  };

  // ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ å…¥åŠ›ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹é›¢è„±æ™‚ã«è‡ªå‹•å¤‰æ›
  const handleLapTimeBlur = (e: React.FocusEvent<HTMLInputElement>) => {
    const value = e.target.value;
    if (value.trim()) {
      const formatted = formatSecondsInput(value);
      setCurrentLap(formatted);
    }
  };

  // ãƒ©ãƒƒãƒ—è¿½åŠ å‡¦ç†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
  const addLapTime = () => {
    if (!currentLap.trim()) return;
    
    const formattedTime = formatSecondsInput(currentLap);
    const lapSeconds = parseTimeToSeconds(formattedTime);
    const lapDistance = parseFloat(currentLapDistance) || getLapDistanceTemplate();
    
    if (lapSeconds <= 0 || lapDistance <= 0) return;
    
    // è·é›¢è¶…éãƒã‚§ãƒƒã‚¯
    const currentTotalDistance = lapTimes.reduce((sum, lap) => sum + lap.distance, 0);
    const newTotalDistance = currentTotalDistance + lapDistance;
    
    if (formData.distance > 0 && newTotalDistance > formData.distance) {
      const remaining = formData.distance - currentTotalDistance;
      const confirmMessage = `ã“ã®ãƒ©ãƒƒãƒ—ã‚’è¿½åŠ ã™ã‚‹ã¨ç·è·é›¢ãŒ${newTotalDistance}mã¨ãªã‚Šã€ãƒ¬ãƒ¼ã‚¹è·é›¢${formData.distance}mã‚’${newTotalDistance - formData.distance}mè¶…éã—ã¾ã™ã€‚\n\næ®‹ã‚Šè·é›¢: ${remaining}m\n\nè¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
    }
    
    setLapTimes(prev => [...prev, { 
      lap: prev.length + 1, 
      time: formattedTime,
      seconds: lapSeconds,
      distance: lapDistance 
    }]);
    setCurrentLap('');
  };

  // Enterã‚­ãƒ¼ã§ã®ãƒ©ãƒƒãƒ—è¿½åŠ 
  const handleLapKeyPress = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addLapTime();
    }
  };

  // ãƒ©ãƒƒãƒ—å‰Šé™¤å‡¦ç†
  const removeLapTime = (index: number) => {
    setLapTimes(prev => prev.filter((_, i) => i !== index));
  };

  // è·é›¢å¤‰æ›´æ™‚ã«ãƒ©ãƒƒãƒ—è·é›¢ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
  React.useEffect(() => {
    if (formData.distance > 0) {
      setCurrentLapDistance(getLapDistanceTemplate().toString());
    }
  }, [formData.distance, formData.raceType]);

  // ãƒˆãƒ©ãƒƒã‚¯ç¨®ç›®ã®è©³ç´°é¸æŠè‚¢ï¼ˆäºˆé¸ãƒ»æ±ºå‹ãƒ»è¨˜éŒ²ä¼šï¼‰
  const trackDistances = [
    { value: '800_preliminary', label: '800mï¼ˆäºˆé¸ï¼‰', distance: 800 },
    { value: '800_final', label: '800mï¼ˆæ±ºå‹ï¼‰', distance: 800 },
    { value: '800_time_trial', label: '800mï¼ˆè¨˜éŒ²ä¼šï¼‰', distance: 800 },
    { value: '1500_preliminary', label: '1500mï¼ˆäºˆé¸ï¼‰', distance: 1500 },
    { value: '1500_final', label: '1500mï¼ˆæ±ºå‹ï¼‰', distance: 1500 },
    { value: '1500_time_trial', label: '1500mï¼ˆè¨˜éŒ²ä¼šï¼‰', distance: 1500 },
    { value: '3000_preliminary', label: '3000mï¼ˆäºˆé¸ï¼‰', distance: 3000 },
    { value: '3000_final', label: '3000mï¼ˆæ±ºå‹ï¼‰', distance: 3000 },
    { value: '3000_time_trial', label: '3000mï¼ˆè¨˜éŒ²ä¼šï¼‰', distance: 3000 },
    { value: '5000_preliminary', label: '5000mï¼ˆäºˆé¸ï¼‰', distance: 5000 },
    { value: '5000_final', label: '5000mï¼ˆæ±ºå‹ï¼‰', distance: 5000 },
    { value: '5000_time_trial', label: '5000mï¼ˆè¨˜éŒ²ä¼šï¼‰', distance: 5000 },
    { value: '10000_preliminary', label: '10000mï¼ˆäºˆé¸ï¼‰', distance: 10000 },
    { value: '10000_final', label: '10000mï¼ˆæ±ºå‹ï¼‰', distance: 10000 },
    { value: '10000_time_trial', label: '10000mï¼ˆè¨˜éŒ²ä¼šï¼‰', distance: 10000 },
    { value: 'custom', label: 'ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰', distance: 0 }
  ];

  // ãƒ­ãƒ¼ãƒ‰ç¨®ç›®ã®é¸æŠè‚¢
  const roadDistances = [
    { value: '5km', label: '5km', distance: 5000 },
    { value: '10km', label: '10km', distance: 10000 },
    { value: 'half_marathon', label: 'ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³', distance: 21097 },
    { value: 'full_marathon', label: 'ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³', distance: 42195 },
    { value: 'custom', label: 'ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰', distance: 0 }
  ];

  // é§…ä¼ã¯åŒºé–“è·é›¢å…¥åŠ›ã®ã¿
  const ekidenDistances = [
    { value: 'custom', label: 'åŒºé–“è·é›¢ã‚’å…¥åŠ›', distance: 0 }
  ];

  const getDistanceOptions = () => {
    switch(formData.raceType) {
      case 'track': return trackDistances;
      case 'road': return roadDistances;
      case 'relay': return ekidenDistances;
      default: return [];
    }
  };

  // ã‚¿ã‚¤ãƒ æ–‡å­—åˆ—ã®æ¤œè¨¼
  const validateTimeString = (timeStr: string) => {
    if (!timeStr.trim()) return '';
    
    // ãƒˆãƒ©ãƒƒã‚¯ç¨®ç›®ç”¨æ­£è¦è¡¨ç¾ï¼ˆå°æ•°ç¬¬äºŒä½å¯¾å¿œï¼‰
    const trackRegex = /^(\d{1,2}):([0-5]?\d(?:\.\d{1,2})?)$|^(\d{1,2}):([0-5]?\d):([0-5]?\d(?:\.\d{1,2})?)$/;
    // ãƒ­ãƒ¼ãƒ‰ãƒ»é§…ä¼ç”¨æ­£è¦è¡¨ç¾ï¼ˆæ•´æ•°ç§’ã®ã¿ï¼‰
    const roadRegex = /^(\d{1,2}):([0-5]?\d)$|^(\d{1,2}):([0-5]?\d):([0-5]?\d)$/;
    
    const regex = formData.raceType === 'track' ? trackRegex : roadRegex;
    
    if (!regex.test(timeStr)) {
      return formData.raceType === 'track' 
        ? 'æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 12.50 ã¾ãŸã¯ 2:15.34ï¼‰'
        : 'æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 25:30 ã¾ãŸã¯ 1:25:30ï¼‰';
    }
    
    return '';
  };

  // ã‚¿ã‚¤ãƒ å¤‰æ›ã®æ”¹å–„ç‰ˆ
  const parseTimeToSeconds = (timeStr: string) => {
    if (!timeStr.trim()) return 0;
    
    const parts = timeStr.split(':');
    
    try {
      if (parts.length === 2) {
        // MM:SS ã¾ãŸã¯ MM:SS.XX
        const minutes = parseInt(parts[0]);
        const seconds = parseFloat(parts[1]);
        
        if (isNaN(minutes) || isNaN(seconds) || minutes < 0 || seconds >= 60) {
          return 0;
        }
        
        return minutes * 60 + seconds;
      } else if (parts.length === 3) {
        // HH:MM:SS ã¾ãŸã¯ HH:MM:SS.XX
        const hours = parseInt(parts[0]);
        const minutes = parseInt(parts[1]);
        const seconds = parseFloat(parts[2]);
        
        if (isNaN(hours) || isNaN(minutes) || isNaN(seconds) || 
            hours < 0 || minutes >= 60 || seconds >= 60) {
          return 0;
        }
        
        return hours * 3600 + minutes * 60 + seconds;
      }
    } catch (error) {
      return 0;
    }
    
    return 0;
  };

  // ã‚¿ã‚¤ãƒ å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ”¹å–„ç‰ˆ
  const handleTimeChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setTimeString(value);
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    const error = validateTimeString(value);
    setTimeError(error);
    
    // ã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã®ã¿ç§’æ•°å¤‰æ›
    if (!error && value.trim()) {
      const seconds = parseTimeToSeconds(value);
      if (seconds > 0) {
        setFormData(prev => ({ ...prev, timeSeconds: seconds }));
      }
    } else if (!value.trim()) {
      setFormData(prev => ({ ...prev, timeSeconds: 0 }));
    }
  };

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›åˆ¶é™ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›æ™‚ã®åˆ¶å¾¡ï¼‰
  const handleTimeKeyPress = (e: React.KeyboardEvent<HTMLInputElement>) => {
    const allowedChars = /[0-9:.]/;
    if (!allowedChars.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') {
      e.preventDefault();
    }
  };

  // äºˆé¸ãƒ»æ±ºå‹ãƒ»è¨˜éŒ²ä¼šã«å¿œã˜ãŸã‚¯ã‚¤ãƒƒã‚¯ã‚¿ã‚¤ãƒ 
  const getQuickTimesByDistance = () => {
    if (formData.raceType === 'track') {
      const baseDistance = formData.distance;
      const isTimeTrialOrPreliminary = formData.raceSubType?.includes('time_trial') || formData.raceSubType?.includes('preliminary');
      
      // åŸºæœ¬ã‚¿ã‚¤ãƒ è¨­å®š
      let baseTimes = [];
      switch(baseDistance) {
        case 800:
          baseTimes = ['1:45.00', '2:00.00', '2:15.00', '2:30.00', '2:45.00', '3:00.00'];
          break;
        case 1500:
          baseTimes = ['3:30.00', '4:00.00', '4:30.00', '5:00.00', '5:30.00', '6:00.00'];
          break;
        case 3000:
          baseTimes = ['8:00.00', '9:00.00', '10:00.00', '11:00.00', '12:00.00', '13:00.00'];
          break;
        case 5000:
          baseTimes = ['14:00.00', '15:30.00', '17:00.00', '18:30.00', '20:00.00', '22:00.00'];
          break;
        case 10000:
          baseTimes = ['30:00.00', '33:00.00', '36:00.00', '40:00.00', '44:00.00', '48:00.00'];
          break;
        default:
          return [];
      }
      
      // è¨˜éŒ²ä¼šã‚„äºˆé¸ã®å ´åˆã¯å°‘ã—é…ã‚ã®ã‚¿ã‚¤ãƒ ã‚‚è¿½åŠ 
      if (isTimeTrialOrPreliminary && baseTimes.length > 0) {
        // ã‚ˆã‚Šå¹…åºƒã„ã‚¿ã‚¤ãƒ ç¯„å›²ã‚’æä¾›
        return baseTimes;
      }
      
      return baseTimes;
    } else if (formData.raceType === 'road') {
      switch(formData.distance) {
        case 5000: // 5km
          // ãƒˆãƒ©ãƒƒã‚¯5000mã¨åŒã˜ã‚¿ã‚¤ãƒ ã«çµ±ä¸€
          return ['14:00', '15:30', '17:00', '18:30', '20:00', '22:00'];
        case 10000: // 10km
          // ãƒˆãƒ©ãƒƒã‚¯10000mã¨åŒã˜ã‚¿ã‚¤ãƒ ã«çµ±ä¸€
          return ['30:00', '33:00', '36:00', '40:00', '44:00', '48:00'];
        case 21097: // ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³
          // ä¸€èˆ¬å¸‚æ°‘ãƒ©ãƒ³ãƒŠãƒ¼ã®ãƒãƒ¼ãƒ•ï¼š1æ™‚é–“10åˆ†ï½2æ™‚é–“30åˆ†
          return ['1:10:00', '1:25:00', '1:40:00', '1:55:00', '2:10:00', '2:25:00'];
        case 42195: // ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³
          // ä¸€èˆ¬å¸‚æ°‘ãƒ©ãƒ³ãƒŠãƒ¼ã®ãƒ•ãƒ«ï¼š2æ™‚é–“30åˆ†ï½5æ™‚é–“30åˆ†
          return ['2:30:00', '3:15:00', '3:45:00', '4:15:00', '4:45:00', '5:15:00'];
        default:
          return [];
      }
    } else {
      // é§…ä¼ - åŒºé–“è·é›¢ã«ã‚ˆã‚Šå¤‰å‹•ã™ã‚‹ãŸã‚æ±ç”¨çš„ãªç¯„å›²
      return ['8:00', '12:00', '16:00', '20:00', '25:00', '30:00'];
    }
  };

  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¿ã‚¤ãƒ é¸æŠã®æ”¹å–„ç‰ˆ
  const handleQuickTime = (timeValue: string) => {
    setTimeString(timeValue);
    setTimeError('');
    const seconds = parseTimeToSeconds(timeValue);
    setFormData(prev => ({ ...prev, timeSeconds: seconds }));
  };

  // è·é›¢é¸æŠï¼ˆç¬¬1æ®µéšï¼‰
  const handleDistanceSelect = (distance: number | string) => {
    setSelectedDistance(distance.toString());
    setSelectedSubType(''); // è·é›¢å¤‰æ›´æ™‚ã¯ç¨®åˆ¥ã‚’ãƒªã‚»ãƒƒãƒˆ
    
    if (formData.raceType !== 'track' && distance !== 'custom') {
      // ãƒˆãƒ©ãƒƒã‚¯ä»¥å¤–ã¯è·é›¢é¸æŠã ã‘ã§å®Œäº†
      setFormData(prev => ({
        ...prev,
        distance: distance as number,
        raceSubType: 'standard'
      }));
    }
  };

  // ç¨®åˆ¥é¸æŠï¼ˆç¬¬2æ®µéšï¼‰
  const handleSubTypeSelect = (subType: string) => {
    setSelectedSubType(subType);
    
    if (selectedDistance && selectedDistance !== 'custom') {
      setFormData(prev => ({
        ...prev,
        distance: parseFloat(selectedDistance),
        raceSubType: `${selectedDistance}_${subType}`
      }));
    }
  };

  // ã‚«ã‚¹ã‚¿ãƒ è·é›¢
  const handleCustomDistance = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setCustomDistance(value);
    const numValue = parseFloat(value);
    if (!isNaN(numValue) && numValue > 0) {
      const meters = formData.raceType === 'relay' ? numValue * 1000 : numValue;
      setFormData(prev => ({
        ...prev,
        distance: meters,
        raceSubType: 'custom'
      }));
    }
  };

  // ãƒ¬ãƒ¼ã‚¹ç¨®ç›®å¤‰æ›´å‡¦ç†
  const handleRaceTypeChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData(prev => ({
      ...prev,
      raceType: e.target.value,
      distance: 0,
      raceSubType: ''
    }));
    setSelectedDistance('');
    setSelectedSubType('');
    setCustomDistance('');
    setTimeError('');
  };

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.raceName.trim()) {
      toast.warning('å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'å¤§ä¼šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
      return
    }
    
    if (formData.timeSeconds <= 0) {
      toast.warning('å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'ã‚¿ã‚¤ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
      return
    }

    if (formData.distance <= 0) {
      toast.warning('å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'è·é›¢ã‚’é¸æŠã—ã¦ãã ã•ã„')
      return
    }

    // ãƒˆãƒ©ãƒƒã‚¯ç¨®ç›®ã®ç¨®åˆ¥é¸æŠãƒã‚§ãƒƒã‚¯
    if (formData.raceType === 'track' && !formData.raceSubType) {
      toast.warning('å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'ç¨®åˆ¥ï¼ˆäºˆé¸ãƒ»æ±ºå‹ãƒ»è¨˜éŒ²ä¼šï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„')
      return
    }

    // APIé€ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™
    const submitData = {
      race_name: formData.raceName,
      race_date: formatDateFromSlash(formData.date),
      race_type: formData.raceType,
      distance: formData.distance,
      time_seconds: formData.timeSeconds,
      position: formData.position || null,
      participants: formData.participants || null,
      notes: formData.notes || null
    };

    console.log('é€ä¿¡å‰ãƒ‡ãƒ¼ã‚¿è©³ç´°:', submitData);

    try {
      // apiClientã‚’ä½¿ç”¨ã—ã¦èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è‡ªå‹•è¿½åŠ 
      const { apiClient } = await import('@/lib/api')
      
      await apiClient.createRace(submitData)
      
      toast.success('ä¿å­˜å®Œäº†', 'ãƒ¬ãƒ¼ã‚¹çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸï¼')
      
      // è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
      localStorage.removeItem(AUTO_SAVE_KEY)
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      setFormData({
        raceName: '',
        date: getCurrentDateSlash(),
        raceType: 'track',
        distance: 0,
        raceSubType: '',
        timeSeconds: 0,
        pace: '',
        position: '',
        participants: '',
        notes: ''
      });
      setTimeString('');
      setTimeError('');
      setSelectedDistance('');
      setSelectedSubType('');
      setCustomDistance('');
      setLapTimes([]);
      setCurrentLap('');
      setCurrentLapDistance('');
      
    } catch (error) {
      console.error('ãƒ¬ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      toast.error('ä¿å­˜å¤±æ•—', `ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'Unknown error'}`)
    }
  };

  const isCustomSelected = selectedDistance === 'custom';

  if (authLoading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</p>
        </div>
      </div>
    )
  }

  if (!isAuthenticated) {
    return (
      <div className="text-center py-8">
        <p className="text-gray-600">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
      </div>
    )
  }

  return (
    <div className="max-w-2xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">æ–°ã—ã„ãƒ¬ãƒ¼ã‚¹çµæœ</h1>

      <form onSubmit={handleSubmit} className="space-y-6">
              <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">æ—¥ä»˜ *</label>
                <DateInput
                  value={formData.date}
                  onChange={(value) => setFormData(prev => ({ ...prev, date: value }))}
                  placeholder="2024/1/1"
                />
              </div>

              <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">å¤§ä¼šå *</label>
                <input
                  type="text"
            value={formData.raceName}
            onChange={(e: React.ChangeEvent<HTMLInputElement>) => setFormData(prev => ({ ...prev, raceName: e.target.value }))}
                  placeholder="ä¾‹: æ±äº¬ãƒãƒ©ã‚½ãƒ³"
            className="w-full p-3 border border-gray-300 rounded-md"
            required
                />
              </div>

              <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">ãƒ¬ãƒ¼ã‚¹ç¨®ç›® *</label>
          <div className="flex space-x-4">
            {['track', 'road', 'relay'].map(type => (
              <label key={type} className="flex items-center">
                      <input
                        type="radio"
                  value={type}
                  checked={formData.raceType === type}
                  onChange={handleRaceTypeChange}
                        className="mr-2"
                      />
                {type === 'track' ? 'ãƒˆãƒ©ãƒƒã‚¯' : type === 'road' ? 'ãƒ­ãƒ¼ãƒ‰' : 'é§…ä¼'}
                    </label>
                  ))}
                </div>
              </div>

        {/* 2æ®µéšè·é›¢é¸æŠ */}
        {formData.raceType === 'relay' ? (
          // é§…ä¼ã¯åŒºé–“è·é›¢å…¥åŠ›ã®ã¿
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">åŒºé–“è·é›¢ * (km)</label>
                        <input
              type="number"
              step="0.1"
              value={customDistance}
              onChange={handleCustomDistance}
              placeholder="ä¾‹: 5.8"
              className="w-full p-3 border border-gray-300 rounded-md"
              required
            />
            <p className="text-sm text-gray-500 mt-1">
              ã‚ãªãŸãŒèµ°ã£ãŸåŒºé–“ã®è·é›¢ã‚’kmå˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„
            </p>
          </div>
        ) : (
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              è·é›¢ *
                      </label>
            
            {/* ç¬¬1æ®µéšï¼šè·é›¢é¸æŠ */}
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4">
              {(formData.raceType === 'track' ? [
                { value: 800, label: '800m' },
                { value: 1500, label: '1500m' },
                { value: 3000, label: '3000m' },
                { value: 5000, label: '5000m' },
                { value: 10000, label: '10000m' },
                { value: 'custom', label: 'ãã®ä»–' }
              ] : [
                { value: 5000, label: '5km' },
                { value: 10000, label: '10km' },
                { value: 21097, label: 'ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³' },
                { value: 42195, label: 'ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³' },
                { value: 'custom', label: 'ãã®ä»–' }
              ]).map((distance) => (
                <button
                  key={distance.value}
                  type="button"
                  onClick={() => handleDistanceSelect(distance.value)}
                  className={`p-3 text-sm border rounded-md transition-colors ${
                    selectedDistance === distance.value.toString()
                      ? 'bg-blue-600 text-white border-blue-600 shadow-md'
                      : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                  }`}
                >
                  {distance.label}
                </button>
                    ))}
                  </div>

            {/* ç¬¬2æ®µéšï¼šãƒˆãƒ©ãƒƒã‚¯ç¨®ç›®ã®ç¨®åˆ¥é¸æŠ */}
            {formData.raceType === 'track' && selectedDistance && selectedDistance !== 'custom' && (
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ç¨®åˆ¥ *
                  </label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'preliminary', label: 'äºˆé¸' },
                    { value: 'final', label: 'æ±ºå‹' },
                    { value: 'time_trial', label: 'è¨˜éŒ²ä¼š' }
                  ].map((subType) => (
                    <button
                      key={subType.value}
                      type="button"
                      onClick={() => handleSubTypeSelect(subType.value)}
                      className={`p-3 text-sm border rounded-md transition-colors ${
                        selectedSubType === subType.value
                          ? 'bg-green-600 text-white border-green-600 shadow-md'
                          : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                      }`}
                    >
                      {subType.label}
                    </button>
                  ))}
                </div>
                </div>
              )}

            {/* ã‚«ã‚¹ã‚¿ãƒ è·é›¢å…¥åŠ› */}
            {selectedDistance === 'custom' && (
              <div className="mt-3">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  è·é›¢ã‚’å…¥åŠ› (m)
                </label>
                <input
                  type="number"
                  step="1"
                  value={customDistance}
                  onChange={handleCustomDistance}
                  placeholder="ä¾‹: 800"
                  className="w-full p-3 border border-gray-300 rounded-md"
                  required
                />
              </div>
            )}

            {/* é¸æŠç¢ºèªè¡¨ç¤º */}
            {selectedDistance && selectedDistance !== 'custom' && (
              <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md">
                <p className="text-blue-800 text-sm">
                  <span className="font-semibold">é¸æŠä¸­:</span> 
                  {formData.raceType === 'track' 
                    ? `${selectedDistance}m${selectedSubType ? ` (${selectedSubType === 'preliminary' ? 'äºˆé¸' : selectedSubType === 'final' ? 'æ±ºå‹' : 'è¨˜éŒ²ä¼š'})` : ''}`
                    : `${selectedDistance === '5000' ? '5km' : selectedDistance === '10000' ? '10km' : selectedDistance === '21097' ? 'ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³' : selectedDistance === '42195' ? 'ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³' : selectedDistance + 'm'}`
                  }
                </p>
                {formData.raceType === 'track' && !selectedSubType && (
                  <p className="text-blue-600 text-xs mt-1">ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                )}
              </div>
            )}
                  </div>
        )}

        {/* ã‚¿ã‚¤ãƒ å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                  <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">ã‚¿ã‚¤ãƒ  *</label>
                    <input
                      type="text"
            value={timeString}
            onChange={handleTimeChange}
            onKeyPress={handleTimeKeyPress}
            placeholder={formData.raceType === 'track' ? "MM:SS.XX ã¾ãŸã¯ HH:MM:SS.XX" : "MM:SS ã¾ãŸã¯ HH:MM:SS"}
            className={`w-full p-3 border rounded-md font-mono text-lg ${
              timeError 
                ? 'border-red-500 bg-red-50' 
                : 'border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200'
            }`}
            required
          />
          
          {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
          {timeError && (
            <p className="text-red-500 text-sm mt-1">{timeError}</p>
          )}
          
          {/* å…¥åŠ›ã‚¬ã‚¤ãƒ‰ */}
          <p className="text-gray-500 text-sm mt-1">
            {formData.raceType === 'track' 
              ? 'ãƒˆãƒ©ãƒƒã‚¯ç¨®ç›®ã¯å°æ•°ç¬¬äºŒä½ã¾ã§å…¥åŠ›å¯èƒ½ï¼ˆä¾‹: 12.50ã€2:15.34ï¼‰'
              : 'ãƒ­ãƒ¼ãƒ‰ãƒ»é§…ä¼ã¯ç§’å˜ä½ã§å…¥åŠ›ï¼ˆä¾‹: 25:30ã€1:25:30ï¼‰'
            }
          </p>

          {/* ç¾å®Ÿçš„ãªã‚¿ã‚¤ãƒ è¡¨ç¤º */}
          {formData.distance > 0 && getQuickTimesByDistance().length > 0 && (
            <div className="mt-3">
              <p className="text-sm text-gray-600 mb-2">
                {formData.raceType === 'track' 
                  ? `${formData.distance}m ä¸€èˆ¬çš„ãªã‚¿ã‚¤ãƒ :` 
                  : formData.raceType === 'road'
                  ? `${formData.distance === 5000 ? '5km' : 
                       formData.distance === 10000 ? '10km' :
                       formData.distance === 21097 ? 'ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³' :
                       formData.distance === 42195 ? 'ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³' : 
                       `${(formData.distance/1000).toFixed(1)}km`} ä¸€èˆ¬çš„ãªã‚¿ã‚¤ãƒ :`
                  : 'é§…ä¼åŒºé–“ ä¸€èˆ¬çš„ãªã‚¿ã‚¤ãƒ :'
                }
              </p>
              <div className="grid grid-cols-3 sm:grid-cols-6 gap-2">
                {getQuickTimesByDistance().map((time, index) => (
                  <button
                    key={time}
                    type="button"
                    onClick={() => handleQuickTime(time)}
                    className={`p-2 text-xs border border-gray-300 rounded hover:bg-blue-50 font-mono transition-colors ${
                      index < 2 ? 'bg-green-50' : index < 4 ? 'bg-yellow-50' : 'bg-orange-50'
                    }`}
                    title={index < 2 ? 'é€Ÿã„' : index < 4 ? 'å¹³å‡çš„' : 'ã‚†ã£ãã‚Š'}
                  >
                    {time}
                  </button>
                ))}
              </div>
              <p className="text-xs text-gray-500 mt-1">
                å·¦ã‹ã‚‰ï¼šé€Ÿã„ãƒ»å¹³å‡çš„ãƒ»ã‚†ã£ãã‚Šãªã‚¿ã‚¤ãƒ 
              </p>
                  </div>
          )}

          {/* ç¾åœ¨ã®å…¥åŠ›ç¢ºèª */}
          {timeString && !timeError && (
            <div className="bg-blue-50 p-3 rounded-md mt-3">
              <p className="text-blue-800 text-sm">
                <span className="font-semibold">å…¥åŠ›ã•ã‚ŒãŸã‚¿ã‚¤ãƒ :</span> {timeString}
                <span className="text-blue-600 ml-2">
                  ({formData.timeSeconds.toFixed(2)}ç§’)
                </span>
              </p>
            </div>
          )}
                  </div>

        {/* ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ç™»éŒ² */}
                  <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ï¼ˆä»»æ„ï¼‰</label>
          
          <div className="space-y-2 mb-3">
            {/* ãƒ©ãƒƒãƒ—è·é›¢è¨­å®š */}
            <div className="flex gap-2 items-center">
              <label className="text-sm text-gray-600">ãƒ©ãƒƒãƒ—è·é›¢:</label>
                    <input
                      type="number"
                value={currentLapDistance}
                onChange={(e: React.ChangeEvent<HTMLInputElement>) => setCurrentLapDistance(e.target.value)}
                placeholder="400"
                className="w-20 p-2 border border-gray-300 rounded-md text-sm"
              />
              <span className="text-sm text-gray-600">m</span>
              <button
                type="button"
                onClick={() => setCurrentLapDistance(getLapDistanceTemplate().toString())}
                className="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
              >
                æ¨™æº–({getLapDistanceTemplate()}m)
              </button>
                  </div>
            
            {/* ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ å…¥åŠ› */}
            <div className="flex gap-2">
              <div className="flex-1">
                <input
                  type="text"
                  value={currentLap}
                  onChange={handleLapTimeChange}
                  onBlur={handleLapTimeBlur}
                  onKeyPress={handleLapKeyPress}
                  placeholder="72.5 ã¾ãŸã¯ 1:12.50"
                  className="w-full p-2 border border-gray-300 rounded-md font-mono"
                />
                <p className="text-xs text-gray-500 mt-1">
                  ç§’æ•°ï¼ˆä¾‹: 72.5ï¼‰ã¾ãŸã¯MM:SS.XXï¼ˆä¾‹: 1:12.50ï¼‰ã§å…¥åŠ›
                </p>
              </div>
              <button
                type="button"
                onClick={addLapTime}
                className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
              >
                è¿½åŠ 
              </button>
                </div>
              </div>

          {/* ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ä¸€è¦§ */}
          {lapTimes.length > 0 && (
            <div className="border border-gray-200 rounded-md p-3">
              <p className="text-sm font-medium text-gray-700 mb-2">
                ç™»éŒ²æ¸ˆã¿ãƒ©ãƒƒãƒ—ï¼ˆ{lapTimes.length}å€‹ï¼‰:
              </p>
              <div className="space-y-1">
                {lapTimes.map((lap, index) => {
                  // ç´¯ç©ã‚¿ã‚¤ãƒ ã‚’è¨ˆç®—
                  const cumulativeSeconds = lapTimes.slice(0, index + 1).reduce((sum, l) => sum + l.seconds, 0);
                  const cumulativeTime = formatSecondsToTime(cumulativeSeconds);
                  
                  return (
                    <div key={index} className="flex justify-between items-center bg-gray-50 p-2 rounded">
                      <div className="font-mono text-sm">
                        <span className="font-medium">{lap.distance}m:</span> {lap.time}
                        <span className="text-gray-600 ml-2">
                          (ç´¯ç©: {cumulativeTime})
                        </span>
                      </div>
                      <button
                        type="button"
                        onClick={() => removeLapTime(index)}
                        className="text-red-600 hover:text-red-800 text-sm"
                      >
                        å‰Šé™¤
                      </button>
                    </div>
                  );
                })}
              </div>

              {/* ç´¯ç©è·é›¢è¡¨ç¤ºã¨è­¦å‘Š */}
              <div className="mt-2 pt-2 border-t border-gray-300">
                {(() => {
                  const totalLapDistance = lapTimes.reduce((sum, lap) => sum + lap.distance, 0);
                  const percentage = formData.distance > 0 ? (totalLapDistance / formData.distance) * 100 : 0;
                  const isOverDistance = totalLapDistance > formData.distance;
                  
                  return (
                    <div className={`text-sm ${isOverDistance ? 'text-red-600' : 'text-gray-600'}`}>
                      <p className="font-medium">
                        ç´¯ç©è·é›¢: {totalLapDistance}m / {formData.distance}m 
                        <span className={`ml-2 ${isOverDistance ? 'text-red-700 font-bold' : ''}`}>
                          ({percentage.toFixed(1)}%)
                        </span>
                      </p>
                      {isOverDistance && (
                        <p className="text-red-700 text-xs mt-1 font-medium">
                          âš ï¸ ãƒ©ãƒƒãƒ—è·é›¢ãŒãƒ¬ãƒ¼ã‚¹è·é›¢ã‚’è¶…éã—ã¦ã„ã¾ã™
                        </p>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>
          )}
            </div>

        {/* ãã®ä»–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
        <div className="grid grid-cols-2 gap-4">
              <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">ãƒšãƒ¼ã‚¹</label>
                <input
                  type="text"
              value={formData.pace}
              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setFormData(prev => ({ ...prev, pace: e.target.value }))}
              placeholder="ä¾‹: 4:30/km"
              className="w-full p-3 border border-gray-300 rounded-md"
                />
              </div>
              <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">é †ä½</label>
                <input
                  type="text"
              value={formData.position}
              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setFormData(prev => ({ ...prev, position: e.target.value }))}
              placeholder="ä¾‹: 5ä½"
              className="w-full p-3 border border-gray-300 rounded-md"
                />
              </div>
            </div>

            <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">å‚åŠ è€…æ•°</label>
          <input
            type="text"
            value={formData.participants}
            onChange={(e: React.ChangeEvent<HTMLInputElement>) => setFormData(prev => ({ ...prev, participants: e.target.value }))}
            placeholder="ä¾‹: 500äºº"
            className="w-full p-3 border border-gray-300 rounded-md"
              />
            </div>

            <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¢</label>
          <textarea
            value={formData.notes}
            onChange={(e: React.ChangeEvent<HTMLTextAreaElement>) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
            placeholder="ãƒ¬ãƒ¼ã‚¹ã®æ„Ÿæƒ³ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’..."
            rows={3}
            className="w-full p-3 border border-gray-300 rounded-md"
          />
                  </div>

        {/* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */}
        <div className="bg-gray-100 p-3 rounded text-sm">
          <strong>å…¥åŠ›ç¢ºèª:</strong> 
          ã‚¿ã‚¤ãƒ : {formData.timeSeconds}ç§’ | 
          è·é›¢: {formData.distance}m | 
          ç¨®ç›®: {formData.raceType}
          </div>

          <button
            type="submit"
          className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700"
          >
          ãƒ¬ãƒ¼ã‚¹çµæœã‚’ä¿å­˜
          </button>
      </form>
    </div>
  );
}